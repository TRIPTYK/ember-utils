{"version":3,"file":"store-document.js","sources":["../../src/services/store-document.ts"],"sourcesContent":["import type Model from '@ember-data/model';\nimport type emberData__store from '@ember-data/store';\nimport Service, { service } from '@ember/service';\nimport type JSONAPIAdapter from '@ember-data/adapter/json-api';\nimport getAdapterOrThrow from '../utils/get-adapter-or-throw';\nimport type FetchService from './fetch';\nimport type Owner from '@ember/owner';\n\nexport type FileObject = PersistedFile | UnpersistedFile;\n\nexport interface PersistedFile {\n  filename: string;\n  path: string;\n  id: string;\n}\n\nexport interface UnpersistedFile {\n  filename: string;\n  path?: string;\n  id?: string;\n  file?: File;\n}\n\nexport default class StoreDocumentService extends Service {\n  @service declare store: emberData__store;\n  @service declare fetch: FetchService;\n\n  private adapter: JSONAPIAdapter;\n\n  public constructor(owner: Owner) {\n    super(owner);\n    this.adapter = getAdapterOrThrow(this);\n  }\n\n  /**\n   * Updates or creates a record from a FormData.\n   */\n  public async save<T extends Model>(formData: FormData, endpoint: string) {\n    const id = formData.get('id');\n    if (id) {\n      return this.update<T>(formData, endpoint, id.toString());\n    }\n    return this.create<T>(formData, endpoint);\n  }\n\n  public async create<T extends Model>(\n    formData: FormData,\n    resourceEndpoint: string,\n  ): Promise<T> {\n    const response = await this.fetch.request(\n      `${resourceEndpoint}`,\n      this.createRequestObject('POST', formData),\n    );\n    const data = await response.json();\n    return this.store.pushPayload(data) as T;\n  }\n\n  public async update<T extends Model>(\n    formData: FormData,\n    resourceEndpoint: string,\n    id: string,\n  ): Promise<T> {\n    const response = await this.fetch.request(\n      `${resourceEndpoint}/${id}`,\n      this.createRequestObject('PATCH', formData),\n    );\n    const data = await response.json();\n    return this.store.pushPayload(data) as T;\n  }\n\n  protected createRequestObject(method: 'POST' | 'PATCH', formData: FormData) {\n    return {\n      method,\n      headers: {\n        Accept: 'application/vnd.api+json',\n        Authorization:\n          (this.adapter.headers as Record<string, string>)['Authorization'] ??\n          '',\n      },\n      body: formData,\n    };\n  }\n}\n\ndeclare module '@ember/service' {\n  interface Registry {\n    'store-document': StoreDocumentService;\n  }\n}\n"],"names":["StoreDocumentService","_class","Service","constructor","owner","_initializerDefineProperty","_descriptor","_descriptor2","_defineProperty","adapter","getAdapterOrThrow","save","formData","endpoint","id","get","update","toString","create","resourceEndpoint","response","fetch","request","createRequestObject","data","json","store","pushPayload","method","headers","Accept","Authorization","body","_applyDecoratedDescriptor","prototype","service","configurable","enumerable","writable","initializer"],"mappings":"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"}