{"version":3,"file":"current-changeset.js","sources":["../../src/services/current-changeset.ts"],"sourcesContent":["import { action } from '@ember/object';\nimport type RouterService from '@ember/routing/router-service';\nimport type Transition from '@ember/routing/transition';\nimport Service, { service } from '@ember/service';\nimport { tracked } from '@glimmer/tracking';\n\ninterface DirtyAbleObject {\n  isDirty: boolean;\n}\n\nexport default class CurrentChangeset extends Service {\n  @service declare router: RouterService;\n\n  @tracked changeset?: DirtyAbleObject;\n  @tracked waitingTransition?: Transition;\n  @tracked approvalNeeded?: boolean;\n\n  constructor(props: object | undefined) {\n    super(props);\n    this.router.on('routeWillChange', this.checkTransition);\n    this.router.on('routeDidChange', this.resetTransition);\n  }\n\n  @action\n  resetTransition(transition: Transition) {\n    if (transition.to?.name === transition.from?.name) {\n      return;\n    }\n    this.approvalNeeded = false;\n    this.changeset = undefined;\n  }\n\n  @action\n  checkTransition(transition: Transition) {\n    /**\n     * Same route transition ? Don't block\n     * Aproved ? Don't block\n     */\n    if (\n      transition.to?.name === transition.from?.name ||\n      transition.data['approved']\n    ) {\n      return;\n    }\n\n    if (this.changeset?.isDirty) {\n      this.approvalNeeded = true;\n      this.waitingTransition = transition;\n      transition.abort();\n    }\n  }\n\n  @action\n  approveTransition() {\n    this.approvalNeeded = false;\n    /**\n     * Need to set data otherwise it will be blocked again\n     */\n    this.waitingTransition!.data['approved'] = true;\n    this.waitingTransition?.retry();\n  }\n\n  @action\n  denyTransition() {\n    this.approvalNeeded = false;\n    this.waitingTransition = undefined;\n  }\n\n  willDestroy() {\n    this.router.off('routeWillChange', this.checkTransition);\n    this.router.off('routeDidChange', this.resetTransition);\n    super.willDestroy();\n  }\n}\n\n// DO NOT DELETE: this is how TypeScript knows how to look up your services.\ndeclare module '@ember/service' {\n  interface Registry {\n    'current-changeset': CurrentChangeset;\n  }\n}\n"],"names":["CurrentChangeset","_class","Service","constructor","props","_initializerDefineProperty","_descriptor","_descriptor2","_descriptor3","_descriptor4","router","on","checkTransition","resetTransition","transition","to","name","from","approvalNeeded","changeset","undefined","data","isDirty","waitingTransition","abort","approveTransition","retry","denyTransition","willDestroy","off","_applyDecoratedDescriptor","prototype","service","configurable","enumerable","writable","initializer","tracked","action","Object","getOwnPropertyDescriptor"],"mappings":"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"}